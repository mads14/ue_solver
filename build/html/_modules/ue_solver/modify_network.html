<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ue_solver.modify_network &mdash; UE Solver 2017 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2017',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="UE Solver 2017 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ue_solver.modify_network</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">networkx.readwrite</span> <span class="kn">import</span> <span class="n">json_graph</span>
<span class="c1"># from haversine import haversine</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">ue_solver.conversions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">geopandas.tools</span> <span class="kn">import</span> <span class="n">sjoin</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="kn">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span> <span class="kn">as</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="c1">#####################add_virtual_nodes#####################</span>
<span class="k">def</span> <span class="nf">haversinefunction</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span> <span class="o">=</span> <span class="n">origin</span>
    <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="n">destination</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mi">6371</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="c1"># m</span>

    <span class="n">dlat</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span><span class="p">)</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon2</span><span class="o">-</span><span class="n">lon1</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat1</span><span class="p">))</span> \
        <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat2</span><span class="p">))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">radius</span>

    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">add_virtual_nodes</span><span class="p">(</span><span class="n">networkx_f</span><span class="p">,</span> <span class="n">taz_shpf</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">):</span><span class="c1">#, taz_dict_outf, graph_name):</span>
    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="n">networkx_f</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">json_graph</span><span class="o">.</span><span class="n">node_link_graph</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">tazs</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">taz_shpf</span><span class="p">)</span>
    <span class="n">taz_centroids</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tazs</span><span class="o">.</span><span class="n">centroid</span><span class="p">]</span> 
    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">get_nearest_neighbors</span><span class="p">(</span><span class="n">taz_centroids</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">)</span>

    <span class="n">nid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">nd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;nid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">])</span> <span class="o">+</span><span class="mi">1</span>

    <span class="n">taz_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tazs</span><span class="p">)):</span>
        <span class="c1"># add node to graph</span>
        <span class="n">virtual_nd_coords</span> <span class="o">=</span> <span class="n">taz_centroids</span><span class="p">[</span><span class="n">i</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">nd_out_id</span> <span class="o">=</span> <span class="s1">&#39;virtual&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
        <span class="n">nd_in_id</span> <span class="o">=</span> <span class="s1">&#39;virtual&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">nd_out_id</span><span class="p">,</span> <span class="p">{</span><span class="s1">u&#39;coords&#39;</span><span class="p">:</span> <span class="n">virtual_nd_coords</span><span class="p">,</span> <span class="s1">u&#39;nid&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="p">,</span> <span class="s1">u&#39;virtual_node&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">nd_in_id</span><span class="p">,</span> <span class="p">{</span><span class="s1">u&#39;coords&#39;</span><span class="p">:</span> <span class="n">virtual_nd_coords</span><span class="p">,</span> <span class="s1">u&#39;nid&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="p">,</span> <span class="s1">u&#39;virtual_node&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">neighbor</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="n">neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]]:</span>

            <span class="n">distance</span> <span class="o">=</span> <span class="n">haversinefunction</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">virtual_nd_coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> 
                                         <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">travel_speed</span> <span class="o">=</span> <span class="mf">6.7</span> <span class="c1">#m/s = 15mph</span>

            <span class="c1"># add edges from virtual node to k nearests neighbors</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">u&#39;B&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">u&#39;capacity&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">u&#39;fftt&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="o">/</span><span class="n">travel_speed</span><span class="p">,</span> 
                     <span class="s1">u&#39;freeflow_speed&#39;</span><span class="p">:</span> <span class="n">travel_speed</span><span class="p">,</span> <span class="s1">u&#39;geom&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">virtual_nd_coords</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]],</span> 
                     <span class="s1">u&#39;init&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="p">,</span> <span class="s1">u&#39;lanes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">u&#39;length&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="p">,</span> <span class="s1">u&#39;osm_init&#39;</span><span class="p">:</span> <span class="n">nd_out_id</span><span class="p">,</span>
                     <span class="s1">u&#39;osm_term&#39;</span><span class="p">:</span> <span class="n">neighbor</span><span class="p">,</span> <span class="s1">u&#39;power&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">u&#39;term&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nid&#39;</span><span class="p">],</span> <span class="s1">u&#39;toll&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="s1">u&#39;type&#39;</span><span class="p">:</span> <span class="s1">u&#39;virtual;&#39;</span><span class="p">}</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">nd_out_id</span><span class="p">,</span> <span class="n">neighbor</span><span class="p">,</span> <span class="n">attr_dict</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>


            <span class="c1"># add edges to virtual node from k nearests neighbors</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="s1">u&#39;B&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">u&#39;capacity&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">u&#39;fftt&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="o">/</span><span class="n">travel_speed</span><span class="p">,</span> 
                     <span class="s1">u&#39;freeflow_speed&#39;</span><span class="p">:</span> <span class="n">travel_speed</span><span class="p">,</span> <span class="s1">u&#39;geom&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">],</span> <span class="n">virtual_nd_coords</span><span class="p">],</span>
                     <span class="s1">u&#39;init&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nid&#39;</span><span class="p">],</span> <span class="s1">u&#39;lanes&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">u&#39;length&#39;</span><span class="p">:</span> <span class="n">distance</span><span class="p">,</span> <span class="s1">u&#39;osm_init&#39;</span><span class="p">:</span> <span class="n">neighbor</span><span class="p">,</span> 
                     <span class="s1">u&#39;osm_term&#39;</span><span class="p">:</span> <span class="n">nd_in_id</span><span class="p">,</span> <span class="s1">u&#39;power&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">u&#39;term&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">u&#39;toll&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">u&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> 
                     <span class="s1">u&#39;type&#39;</span><span class="p">:</span> <span class="s1">u&#39;virtual;&#39;</span><span class="p">}</span>

            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">nd_in_id</span><span class="p">,</span> <span class="n">attr_dict</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
        <span class="n">taz_dict</span><span class="p">[</span><span class="n">tazs</span><span class="p">[</span><span class="s1">&#39;TAZ1454&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="p">,</span> <span class="s1">&#39;destination&#39;</span><span class="p">:</span> <span class="n">nid</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">nid</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">taz_dict</span>


<span class="k">def</span> <span class="nf">get_nearest_neighbors</span><span class="p">(</span><span class="n">taz_coords</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">):</span>
    
    <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">nids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="s1">&#39;nid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">node_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;haversine&#39;</span><span class="p">)</span>
    <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">node_coords</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">knn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">taz_coords</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

<span class="c1">#####################append_city_names#####################</span>
<span class="k">def</span> <span class="nf">append_city_names</span><span class="p">(</span><span class="n">ca_cities_shp</span><span class="p">,</span> <span class="n">geojson_f</span><span class="p">):</span>
    <span class="c1"># read links geojson</span>
    <span class="n">links</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">geojson_f</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;city&#39;</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;network already has city labels&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># read city shapefile</span>
    <span class="n">ca_cities</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">ca_cities_shp</span><span class="p">)</span>
    <span class="n">ca_cities</span> <span class="o">=</span> <span class="n">ca_cities</span><span class="p">[[</span><span class="s1">&#39;CityType&#39;</span><span class="p">,</span><span class="s1">&#39;County&#39;</span><span class="p">,</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
    <span class="n">ca_cities</span> <span class="o">=</span> <span class="n">ca_cities</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;NAME&#39;</span><span class="p">:</span><span class="s1">&#39;city&#39;</span><span class="p">,</span><span class="s1">&#39;County&#39;</span><span class="p">:</span><span class="s1">&#39;county&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;CityType&#39;</span><span class="p">:</span><span class="s1">&#39;city_type&#39;</span><span class="p">})</span>

    
    <span class="c1"># spatial join</span>
    <span class="n">links_w_city</span><span class="o">=</span><span class="n">sjoin</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">ca_cities</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="c1"># if link in more than one city, then will be doubled in table, drop duplicates</span>
    <span class="n">links_w_city</span> <span class="o">=</span> <span class="n">links_w_city</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">links_w_city</span> <span class="o">=</span> <span class="n">links_w_city</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;index_right&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_f</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">links_w_city</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

<span class="c1">###########alternative_append_city_names############</span>
<div class="viewcode-block" id="label_road_network"><a class="viewcode-back" href="../../code.html#ue_solver.modify_network.label_road_network">[docs]</a><span class="k">def</span> <span class="nf">label_road_network</span><span class="p">(</span><span class="n">input_shp</span><span class="p">,</span> <span class="n">road_network_geojson</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">geojson_outf</span><span class="p">,</span> <span class="n">rename_attributes</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="c1">#####################append_city_names#####################</span>
    <span class="c1"># read links geojson</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generalized function of append_city_names:</span>
<span class="sd">    Allows user to specify which attributes to keep from the input shape file. </span>
<span class="sd">    Spatial join shape file with network, so that network file now has identifying labels</span>

<span class="sd">    - input_shp: type str, filepath for generalized shapefile for cities, neighborhoods, from any state </span>
<span class="sd">    - road_network_geojson: type str, filepath for input geoJSON network file </span>
<span class="sd">    - attributes: type str OR str array, selected attributes that will be joined</span>
<span class="sd">    - geojson_outf: type str, filepath for output file with identifying labels </span>
<span class="sd">    - rename_attributes: type str OR str array, either string or array of strings (should match attributes), can be used if user</span>
<span class="sd">      would like to rename the attributes to more user-friendly names</span>

<span class="sd">    Example:</span>
<span class="sd">    label_road_network(&#39;maryland_counties.shp&#39;,&#39;network.geojson&#39;,&#39;countyname00&#39;,&#39;new_network.geojson&#39;, &#39;CountyName&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">links</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">road_network_geojson</span><span class="p">)</span>

    <span class="c1"># read input shapefile</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">input_shp</span><span class="p">)</span>

    <span class="c1"># if only one attribute  </span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="p">[[</span><span class="n">attributes</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">rename_attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">attributes</span><span class="p">:</span><span class="n">rename_attributes</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Column name is not in input_shp&quot;</span><span class="p">)</span>

    <span class="c1"># if multiple attributes</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="c1"># check if column name in input_shp</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Column name is not in input_shp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;geometry&#39;</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="p">[[</span><span class="n">attributes</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rename_attributes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of attributes different from number of rename attributes.&quot;</span><span class="p">)</span>
        <span class="n">rename_columns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">)):</span>
            <span class="n">rename_columns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">rename_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>
        <span class="n">network</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">rename_columns</span><span class="p">)</span>
    <span class="c1"># spatial join</span>
    <span class="n">links_w_city</span> <span class="o">=</span> <span class="n">sjoin</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">network</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span></div>



<span class="c1">#####################update_cap#####################</span>
<div class="viewcode-block" id="update_capacity"><a class="viewcode-back" href="../../code.html#ue_solver.modify_network.update_capacity">[docs]</a><span class="k">def</span> <span class="nf">update_capacity</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">,</span> <span class="n">percent_cap</span><span class="p">,</span> <span class="n">geojson_inf</span><span class="p">,</span> 
                    <span class="n">geojson_outf</span><span class="p">,</span> <span class="n">graph_f</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    update a network file by changing the capacity according to the fields in attr_dict</span>
<span class="sd">    </span>
<span class="sd">    - attr_dict = {key: [list of values that will be changed]}</span>
<span class="sd">        example: {&#39;county&#39;: [&#39;Alameda&#39;, &#39;Berkeley&#39;, &#39;Emeryville&#39;]}</span>
<span class="sd">    - precent_cap = type decimal, percent of existing capacity roads will now have</span>
<span class="sd">    - geojson_in = type str, filepath network geojson file</span>
<span class="sd">    - geojson_out = type str, filepath save locations of modified network geojson file</span>
<span class="sd">    - graph_f = path of updated networkx or None if don&#39;t want to save networkx graph</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">links</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geojson_inf</span><span class="p">)</span>

    <span class="n">roads_to_update</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># if k == &#39;type&#39;:</span>
        <span class="c1">#     v = [r+&#39;;&#39; for r in v]</span>
        <span class="n">roads_to_update</span> <span class="o">=</span> <span class="n">roads_to_update</span> <span class="o">&amp;</span> <span class="n">links</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        
    <span class="c1"># Change capacity of city Arterials and save to dataframe</span>
    <span class="n">links</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roads_to_update</span><span class="p">,</span>
                                 <span class="n">links</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">percent_cap</span><span class="p">,</span>
                                 <span class="n">links</span><span class="p">[</span><span class="s1">&#39;capacity&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">links</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">graph_f</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">geojson_to_networkx</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">,</span> <span class="n">graph_f</span><span class="p">)</span></div>

<span class="c1">#####################cut_links#####################</span>
<div class="viewcode-block" id="cut_links"><a class="viewcode-back" href="../../code.html#ue_solver.modify_network.cut_links">[docs]</a><span class="k">def</span> <span class="nf">cut_links</span><span class="p">(</span><span class="n">geojson_inf</span><span class="p">,</span> <span class="n">links_f</span><span class="p">,</span> <span class="n">geojson_outf</span><span class="p">,</span> <span class="n">graph_outf</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Removes links in the road network to simulate roads being closed off or inaccessible. </span>

<span class="sd">    - geojson_inf: type str geoJSON file, filepath network geojson file</span>
<span class="sd">    - links_f: type str CSV file, filepath for csv file of links to delete   </span>
<span class="sd">    - geojson_outf: type str geoJSON file, filepath save locations of modified network geojson file</span>
<span class="sd">    - graph_outf: type str networkx file, reconstructed graph file from geojson outfile </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">geojson_f</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">geojson_inf</span><span class="p">)</span>
    <span class="n">geojson_f</span><span class="p">[[</span><span class="s1">&#39;osm_init&#39;</span><span class="p">,</span><span class="s1">&#39;osm_term&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">geojson_f</span><span class="p">[[</span><span class="s1">&#39;osm_init&#39;</span><span class="p">,</span><span class="s1">&#39;osm_term&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">)</span>
    
    <span class="c1"># Read csv to df</span>
    <span class="n">cut_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">links_f</span><span class="p">)</span>
    
    <span class="c1"># Add a label column</span>
    <span class="n">cut_links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;osm_init&#39;</span><span class="p">,</span><span class="s1">&#39;osm_term&#39;</span><span class="p">]</span>
    <span class="n">cut_links_df</span><span class="p">[</span><span class="s1">&#39;cut_links&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cut_links_df</span><span class="p">[</span><span class="s1">&#39;osm_init&#39;</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">geojson_f</span><span class="p">,</span> <span class="n">cut_links_df</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;osm_init&#39;</span><span class="p">,</span> <span class="s1">&#39;osm_term&#39;</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;cut_links&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cut_links&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    

    <span class="c1"># save network geojson</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

    <span class="n">G</span> <span class="o">=</span> <span class="n">geojson_to_networkx</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">remove_non_accessible_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">reassign_node_ids</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>    

    <span class="n">save_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">graph_outf</span><span class="p">)</span></div>

<div class="viewcode-block" id="remove_non_accessible_nodes"><a class="viewcode-back" href="../../code.html#ue_solver.modify_network.remove_non_accessible_nodes">[docs]</a><span class="k">def</span> <span class="nf">remove_non_accessible_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">start_node</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    remove all nodes in graph G that are not accessible from the start node.</span>
<span class="sd">    If start_node = None, then set start node to middle node.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
    <span class="n">start_node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()[</span><span class="n">l</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># filter for path from center node</span>
    <span class="n">node_list</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
    <span class="n">to_keep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">bfs_tree</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">start_node</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span><span class="p">()),</span> <span class="p">())))</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_keep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
         <span class="n">G</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># filter for path to center node</span>
    <span class="n">node_list</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span>
    <span class="n">to_keep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">bfs_tree</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span><span class="p">()),</span> <span class="p">())))</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_keep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
         <span class="n">G</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">G</span></div>
    

<div class="viewcode-block" id="reassign_node_ids"><a class="viewcode-back" href="../../code.html#ue_solver.modify_network.reassign_node_ids">[docs]</a><span class="k">def</span> <span class="nf">reassign_node_ids</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    assign node ids 1,...,number_of_nodes, to the nodes in the graph</span>
<span class="sd">    assign init and term properties to the corresponding links.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#assign nids to nodes</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">osmId_2_nId</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">():</span>
        <span class="n">osmId_2_nId</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="c1"># osmId_2_gId[int(osmId)] = gId</span>
        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;nid&#39;</span><span class="p">,</span> <span class="n">osmId_2_nId</span><span class="p">)</span>

    <span class="c1">#assign init and term to appropriate links</span>
    <span class="n">st_ids</span> <span class="o">=</span><span class="p">{}</span>
    <span class="n">end_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">st_ids</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">osmId_2_nId</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">end_ids</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">osmId_2_nId</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">st_ids</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="n">end_ids</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">G</span></div>

<span class="k">def</span> <span class="nf">remove_duplicate_links</span><span class="p">(</span><span class="n">geojson_inf</span><span class="p">,</span> <span class="n">geojson_outf</span><span class="p">):</span>
    <span class="n">networkdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">geojson_inf</span><span class="p">)</span>
    <span class="n">networkdf</span> <span class="o">=</span> <span class="n">networkdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">,</span> <span class="s1">&#39;capacity&#39;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">networkdf</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;term&#39;</span><span class="p">],</span> <span class="n">keep</span> <span class="o">=</span> <span class="s1">&#39;last&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;osm_init&#39;</span><span class="p">,</span> <span class="s1">&#39;osm_term&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_outf</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Maddie Sheehan, Heather Chen.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>